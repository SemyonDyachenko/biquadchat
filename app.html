<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
    <title>Biquad app</title>
</head>
<body>
    <div class="biquadapp">
        <div class="_openchat-section biquad">
            <div class="_chatopen-btn biquad">
                <div class="_openline biquad">
                    <span class="_openline_promo biquad"><i class="fas fa-comments"></i></span>
                </div>
            </div>
        </div>
            <div class="_chatcloser biquad hidden">
                <button class="_clsbutton biquad" type="button"><i class="fas fa-times"></i></button>
            </div>

            <div class="_chatwrapper biquad hidden">
                <div class="divh100 biquad">
                    <div class="_messanger biquad">
                        <div class="_smscontainer biquad">
                            <div class="_smslist biquad">
                                
                            </div>

                            <div class="_sendbox biquad">
                                <form class="_sendform">
                                    <textarea class="_sendinput" placeholder="Напишите сообщение"></textarea>
                                    <button type="button" class="_sendbtn"><i class="fas fa-paper-plane biquad"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    
    

    <style>
        ._openchat-section {
            position:fixed;
            bottom:20px;
            right: 25px;
            z-index:20200620;
            padding:0px;
            margin:0px;
            background: rgb(10, 55, 158);
            background: linear-gradient(90deg, rgb(5, 50, 153) 0%, rgba(0,118,240,1) 78%);
            min-width:80px;
            min-height: 80px;
            max-height: 80px;
            border-radius: 200px;
            cursor: pointer;
            -webkit-box-shadow: 2px 2px 17px -1px rgba(0,36,121,1);
            -moz-box-shadow: 2px 2px 17px -1px rgba(0,36,121,1);
            box-shadow: 2px 2px 17px -1px rgba(0,36,121,1);
            display: flex;
            justify-content: center;
            align-items: center;
            color:white;
            font-family: 'Roboto',sans-serif;
            transition:.3s;
            
        }

        ._openchat-section:hover {
            transition:.3s;
            transform: scale(1.2);
        }

        ._openchat-section i {
            font-size: 25px;
        }

        ._chatwrapper {
            z-index: 2147483000;
            position: fixed;
            bottom: 20px;
            right: 25px;
            height: calc(100% - 60px) !important;
            max-height: 460px !important;
            min-height: 220px !important;
            width: 320px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 2px 10px 40px rgba(22, 20, 19, 0.4);
            /* transform: translateX(300px); */
            transition: 0.3s all ease-out 0.1s;
            -webkit-transition: 0.3s all ease-out 0.1s, transform 0.2s ease-in;
            opacity: 1.0;
            background: #FFFFFF;
            border-radius: 20px;
        }

        .divh100 {
            height:100%;
            border-radius: 20px;
        }

        ._messanger {
            height: 100%;
            background:#FFF;
            position: relative;
            border-radius: 20px;
        }

        ._smscontainer {
           height: 100%;
           border-radius: 20px;
        padding-top:20px;
        padding-left:3px;
        padding-right: 3px;
        box-sizing: border-box;
        
        }

        ._smslist {
            height: calc(100% - 100px);
            -webkit-box-flex: 1;
            flex-direction: column;
            box-sizing: border-box;
            flex: 1 1 0px;
            overflow-x:hidden;
            overflow-y:auto;
            position: relative;
        }

        ._sendform {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            box-shadow: rgba(0, 0, 0, 0.05) 0px -3px 10px 0px;
            background: rgb(255, 255, 255);
            bottom: 0px;
            padding-top:20px;
            position: relative;
            flex-shrink: 0;
            box-shadow: rgba(0, 0, 0, 0.05) 0px -3px 10px 0px;
            z-index: 11;

        }

        ._sendinput {
            background: none;
            border: none;
            outline: none !important;
            resize: none;
            /* color: rgba(255, 255, 255, .8); */
            font-size: 15px;
            height: 52px;
            box-sizing: border-box;
            padding:10px;
            width:255px;
            color: #444;
            border: 1px solid #ccc;
            border-radius: 35px;
        }

        ._sendbtn {
            width: 55px;
            height: 55px;
            background:transparent;
            outline:none;
            border:none;
            cursor: pointer;
        }

        ._sendbtn i {
            font-size:25px;
        }

        ._sendbtn:hover {
            opacity:0.6;
            transition: 0.2s;
        }

        ._chatcloser {
            position: fixed;
            bottom: 500px;
            right: 25px;
        }

        ._clsbutton {
            outline:none;
            border:none;
            cursor: pointer;
            background:none;
        }

        ._clsbutton:hover {
            transform: scale(1.1);
            transition:.3s;
            opacity:0.5;
        }

        ._clsbutton i {
            font-size:40px;
        }

        .hidden {
            display: none;
        }

        ::-webkit-scrollbar {
        width: 4px;
        height: 10px;
        

         }
        ::-webkit-scrollbar-thumb {
            border-radius: 8px;
            background: #c2c9d2;
        }

        .message {
            clear: both;
            float: left;
            padding: 6px 10px 7px;
            border-radius: 20px 20px 20px 0;
            background: #eee;
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.4;
            margin-left: 35px;
            position: relative;
            border: 1px solid transparent;
            white-space:normal;
            max-width: 90%;
            font-family: 'Roboto',sans-serif;
        }

        .message-personal {
            float: right;
            text-align: right;
            background: linear-gradient(120deg, rgb(0, 153, 255), rgb(60, 154, 218)); 
            background-color: rgb(0, 153, 255);
            border: 1px solid transparent;
            border-radius: 20px 20px 0 20px;
            color:white;
            word-wrap: break-word;
            white-space:normal;
            max-width: 90%;
            font-family: 'Roboto',sans-serif;
        }


        .timestep {
            position: absolute;
            bottom: -15px;
            font-size: 10px;
            color: #555;
            right: 30px;
            /* color: rgba(255, 255, 255, .7); */
        }

        
    </style>

    <script>
            const openButton = document.getElementsByClassName('_openchat-section')[0];
            const sendBtn = document.getElementsByClassName('_sendbtn')[0];
            const closeBtn = document.getElementsByClassName('_clsbutton')[0];


            // click event listeners

            openButton.onclick = function() {
          
                document.getElementsByClassName('_openchat-section')[0].style.display = "none";
                document.getElementsByClassName('_chatcloser')[0].classList.remove('hidden');
                document.getElementsByClassName('_chatwrapper')[0].classList.remove('hidden');
         

                get_messages(findUnqiueId());
                
            };
        
            closeBtn.onclick = function() {
                document.getElementsByClassName('_openchat-section')[0].style.display = "";

                document.getElementsByClassName('_chatcloser')[0].classList.add('hidden');
                document.getElementsByClassName('_chatwrapper')[0].classList.add('hidden');
            };
        

            sendBtn.onclick = function(event) {

                if(document.getElementsByClassName("_sendinput")[0].value.length > 0) {
                    let value = document.getElementsByClassName("_sendinput")[0].value;
                    let parent = document.getElementsByClassName('_smslist')[0];


                    sendMessage(parent,value);


                    document.getElementsByClassName("_sendinput")[0].value = "";
                }

            };
        



            async function get_messages(unique_id) {
                let request = new XMLHttpRequest();

                let urls = {
                    mainurl : "https://www.biquad.ru/server/give?unique_id="+String(unique_id),
                    proxyurl : "https://cors-anywhere.herokuapp.com/"
                };

                request.open("GET",urls.proxyurl+urls.mainurl,true);

                request.setRequestHeader("Content-Type", "application/json");

                request.send();

                let json =request.responseText;
                
                //json.push(request.response);
                //jsonString =  JSON.parse(json);
                //console.log(jsonString);
                console.log(json);

            }    


            async function sendMessage(parentDOM,messageText) {
                parentDOM.appendChild(createMessage(messageText));

                createMessageRequest(messageText,String((new Date).getHours()) + ":" + String((new Date).getMinutes()));

                let chatId = findUnqiueId();

                let request = new XMLHttpRequest();

                let urls = {
                    mainurl : "https://www.biquad.ru/server/sendmessage.php",
                    proxyurl : "https://cors-anywhere.herokuapp.com/"
                };

                let Message = {
                    "id" : chatId,
                    "content" : messageText,
                    "time" : (String((new Date).getHours()) + ":" + String((new Date).getMinutes()))
                };

                let result = "";

                let jsonMessage = JSON.stringify(Message);

                request.open('POST',urls.proxyurl+urls.mainurl,true);

                request.setRequestHeader("Content-Type", "application/json");

                request.onreadystatechange = function() {
                    if(request.readyState == 4 && (request.status >= 200 && request.status < 400)) {
                        result = this.responseText;
                    }
                }

                request.send(jsonMessage);
                
            }


            function createMessage(text) {
                let messageWrapper =  document.createElement('div');
                messageWrapper.setAttribute('class','message message-personal');
                messageWrapper.innerText = text;
                let timestep = document.createElement('div');
                timestep.setAttribute('class','timestep');
                let nowTimeStr = String((new Date).getHours()) + ":" + String((new Date).getMinutes());
                timestep.innerText = nowTimeStr;

                messageWrapper.appendChild(timestep);
                
                return messageWrapper;
            }


            function findUnqiueId() {
                return window.biquadId;
            }

            function createMessageRequest(text,time) {
                let chatId = findUnqiueId();

                let request = new XMLHttpRequest();

               

                let urls = {
                    mainurl : "https://www.biquad.ru/server/receive",
                    proxyurl : "https://cors-anywhere.herokuapp.com/"
                };

                let Message = {
                    "id" : chatId,
                    "content" : text,
                    "time" : time
                };

                let result = "";

                let jsonMessage = JSON.stringify(Message);

                request.open('POST',urls.proxyurl+urls.mainurl,true);

                request.setRequestHeader("Content-Type", "application/json");

                request.onreadystatechange = function() {
                    if(request.readyState == 4 && (request.status >= 200 && request.status < 400)) {
                        result = this.responseText;
                    }
                }

                request.send(jsonMessage);

            }  

    </script>

</body>
</html>